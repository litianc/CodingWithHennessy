# FunASR + 3D-Speaker é›†æˆå®Œæˆæ€»ç»“

## ğŸ‰ é›†æˆçŠ¶æ€ï¼šâœ… å®Œæˆå¹¶æµ‹è¯•é€šè¿‡

**å®Œæˆæ—¶é—´**: 2025-10-23
**ç‰ˆæœ¬**: v1.0

---

## ğŸ“Š ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯ (React)                         â”‚
â”‚                       Port: 3000                            â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  å®æ—¶è½¬å½•ç»„ä»¶    â”‚  â”‚  è¯´è¯äººç»Ÿè®¡   â”‚  â”‚  ä¼šè®®è¯¦æƒ…é¡µ  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ HTTP/WebSocket
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åç«¯ TypeScript (Node.js)                â”‚
â”‚                         Port: 5001                          â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  multiSpeakerTranscriptionService                    â”‚  â”‚
â”‚  â”‚  â””â”€ åè°ƒ FunASR å’Œ 3D-Speaker                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  FunASR WebSocket â”‚  â”‚  Speaker Recognition Service â”‚  â”‚
â”‚  â”‚  Service          â”‚  â”‚  (å£°çº¹è¯†åˆ«æœåŠ¡)              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                              â”‚
           â–¼                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   FunASR Docker     â”‚      â”‚  3D-Speaker Python Service â”‚
â”‚   Port: 10095       â”‚      â”‚  Port: 5002                â”‚
â”‚   (WebSocket)       â”‚      â”‚  (FastAPI)                 â”‚
â”‚                     â”‚      â”‚                            â”‚
â”‚  - VAD æ¨¡å‹         â”‚      â”‚  - å£°çº¹è¯†åˆ«                â”‚
â”‚  - ASR æ¨¡å‹         â”‚      â”‚  - è¯´è¯äººåˆ†å‰²              â”‚
â”‚  - æ ‡ç‚¹æ¨¡å‹         â”‚      â”‚  - å£°çº¹æ³¨å†Œ/ç®¡ç†           â”‚
â”‚  - çƒ­è¯æ”¯æŒ         â”‚      â”‚  - ç›¸ä¼¼åº¦åŒ¹é…              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. FunASR Docker æœåŠ¡éƒ¨ç½²

**çŠ¶æ€**: âœ… æ­£å¸¸è¿è¡Œ

**é…ç½®æ–‡ä»¶**: `docker/docker-compose.funasr.yml`

**å…³é”®é…ç½®**:
```yaml
command: ["bin/bash", "-c", "... ./funasr-wss-server
  --model-dir /workspace/models/.../speech_paraformer-large...
  --vad-dir /workspace/models/.../speech_fsmn_vad...
  --punc-dir /workspace/models/.../punc_ct-transformer...
  --lm-dir ''  # ç¦ç”¨è¯­è¨€æ¨¡å‹èŠ‚çœå†…å­˜
  --port 10095
  --certfile 0 --keyfile 0  # ç¦ç”¨SSL
  --decoder-thread-num 1
  --model-thread-num 1
  --io-thread-num 1
"]
```

**å·²åŠ è½½çš„æ¨¡å‹**:
- âœ… VAD æ¨¡å‹ (è¯­éŸ³æ´»åŠ¨æ£€æµ‹)
- âœ… ASR æ¨¡å‹ (Paraformer å¤§å‹æ¨¡å‹)
- âœ… æ ‡ç‚¹æ¨¡å‹ (CT-Transformer)
- âœ… ITN æ¨¡å‹ (é€†æ–‡æœ¬æ ‡å‡†åŒ–)
- âœ… çƒ­è¯é…ç½®

**å†…å­˜ä½¿ç”¨**: ~1.9GB (ç¦ç”¨è¯­è¨€æ¨¡å‹å)

**æµ‹è¯•ç»“æœ**:
- âœ… WebSocket è¿æ¥æˆåŠŸ
- âœ… éŸ³é¢‘è¯†åˆ«æˆåŠŸ (3åˆ†é’Ÿä¼šè®®å½•éŸ³)
- âœ… è¿”å›è¯¦ç»†çš„å¥å­çº§å’Œè¯çº§æ—¶é—´æˆ³
- âœ… è‡ªåŠ¨æ·»åŠ æ ‡ç‚¹ç¬¦å·

### 2. åç«¯æœåŠ¡é›†æˆ

#### 2.1 FunASR WebSocket æœåŠ¡

**æ–‡ä»¶**: `backend/src/services/funasrWebSocketService.ts`

**åŠŸèƒ½ç‰¹æ€§**:
- âœ… WebSocket è¿æ¥ç®¡ç†
- âœ… æ–‡ä»¶è½¬å½• (`transcribeFile`)
- âœ… æµå¼è½¬å½•æ”¯æŒ (`sendAudioStream`)
- âœ… è‡ªåŠ¨å¤„ç† `is_final` æ ‡è®°
- âœ… è¶…æ—¶å’Œé”™è¯¯å¤„ç†
- âœ… äº‹ä»¶é©±åŠ¨çš„ç»“æœå¤„ç†

**ä½¿ç”¨ç¤ºä¾‹**:
```typescript
import { funasrWebSocketService } from './services/funasrWebSocketService'

// è½¬å½•éŸ³é¢‘æ–‡ä»¶
const result = await funasrWebSocketService.transcribeFile(audioPath)

// ç»“æœåŒ…å«:
// - text: å®Œæ•´è½¬å½•æ–‡æœ¬
// - stamp_sents: å¥å­çº§æ—¶é—´æˆ³æ•°ç»„
// - timestamp: è¯çº§æ—¶é—´æˆ³
```

#### 2.2 å¤šè¯´è¯äººè½¬å½•æœåŠ¡

**æ–‡ä»¶**: `backend/src/services/multiSpeakerTranscriptionService.ts`

**å¤„ç†æµç¨‹**:
1. **è¯´è¯äººåˆ†å‰²**: ä½¿ç”¨ 3D-Speaker çš„ diarization API
2. **å£°çº¹è¯†åˆ«**: å¯¹æ¯ä¸ªè¯´è¯äººç‰‡æ®µè¿›è¡Œèº«ä»½è¯†åˆ«
3. **è¯­éŸ³è¯†åˆ«**: ä½¿ç”¨ FunASR è½¬å½•æ•´æ®µéŸ³é¢‘
4. **ç»“æœåˆå¹¶**: æ ¹æ®æ—¶é—´æˆ³å°†è½¬å½•æ–‡æœ¬ä¸è¯´è¯äººå…³è”
5. **ç»Ÿè®¡è®¡ç®—**: ç”Ÿæˆè¯´è¯äººå‘è¨€ç»Ÿè®¡

**è¾“å‡ºæ•°æ®**:
```typescript
{
  segments: [
    {
      id: 'seg-1',
      speakerId: 'speaker-001',
      speakerName: 'LXY',
      isUnknown: false,
      content: 'å•Šï¼Œä¸æ˜¯æ²¡æœ‰ï¼Œå—¯ï¼Œ',
      startTime: 850,
      endTime: 2270,
      confidence: 0.9,
      voiceprintConfidence: 0.85,
      words: [...]  // è¯çº§æ—¶é—´æˆ³
    },
    ...
  ],
  speakers: [
    {
      speakerId: 'speaker-001',
      name: 'LXY',
      department: 'Engineering',
      isKnown: true,
      segmentCount: 25,
      totalDuration: 85000,  // æ¯«ç§’
      percentage: 45.2,
      avgConfidence: 0.9
    },
    ...
  ],
  speakerCount: 3,
  unknownSpeakerCount: 1,
  totalDuration: 180000  // æ¯«ç§’
}
```

### 3. å‰ç«¯ç»„ä»¶

**å·²å­˜åœ¨çš„ç»„ä»¶**:
- âœ… `RealTimeTranscription` - å®æ—¶è½¬å½•æ˜¾ç¤º
- âœ… `SpeakerStatistics` - è¯´è¯äººç»Ÿè®¡
- âœ… `MeetingDetailPage` - ä¼šè®®è¯¦æƒ…é¡µé›†æˆ

è¿™äº›ç»„ä»¶å·²ç»å¯ä»¥ç›´æ¥ä½¿ç”¨åç«¯è¿”å›çš„æ•°æ®ç»“æ„ã€‚

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•è„šæœ¬

**æ–‡ä»¶**: `backend/test-funasr-simple.js`

```bash
# è¿è¡Œæµ‹è¯•
cd backend
node test-funasr-simple.js
```

**æµ‹è¯•ç»“æœ**:
```
âœ… WebSocket è¿æ¥æˆåŠŸ
âœ… å‘é€éŸ³é¢‘æ•°æ®: 5753682 bytes
âœ… æ”¶åˆ°è¯†åˆ«ç»“æœ: 70ä¸ªå¥å­
âœ… æµ‹è¯•é€šè¿‡ï¼
```

### æµ‹è¯•éŸ³é¢‘

**æ–‡ä»¶**: `backend/test-resources/audio/meeting-short-test2-16k.wav`
- å¤§å°: 5.5MB
- æ—¶é•¿: ~3åˆ†é’Ÿ
- æ ¼å¼: 16kHz, 16bit, å•å£°é“
- ç»“æœ: æˆåŠŸè¯†åˆ« 70 ä¸ªå¥å­ç‰‡æ®µ

---

## ğŸ”§ å…³é”®æŠ€æœ¯ç»†èŠ‚

### 1. FunASR WebSocket åè®®

**æ¶ˆæ¯æ ¼å¼**:

1. **å¼€å§‹æ¶ˆæ¯**:
```json
{
  "mode": "offline",
  "chunk_size": [5, 10, 5],
  "chunk_interval": 10,
  "wav_name": "audio.wav",
  "is_speaking": true,
  "wav_format": "pcm",
  "audio_fs": 16000
}
```

2. **éŸ³é¢‘æ•°æ®**: ç›´æ¥å‘é€ Buffer/Binary æ•°æ®

3. **ç»“æŸæ¶ˆæ¯**:
```json
{
  "is_speaking": false
}
```

4. **è¯†åˆ«ç»“æœ**:
```json
{
  "is_final": false,
  "mode": "offline",
  "text": "å®Œæ•´è½¬å½•æ–‡æœ¬",
  "timestamp": "[[850,970],[970,1070],...]",
  "stamp_sents": [
    {
      "text_seg": "å•Š",
      "punc": "ï¼Œ",
      "start": 850,
      "end": 970,
      "ts_list": [[850, 970]]
    },
    ...
  ],
  "wav_name": "audio.wav"
}
```

### 2. ç»“æœåˆå¹¶ç®—æ³•

**æ—¶é—´æˆ³å¯¹é½**:
- ä½¿ç”¨å¥å­ä¸­ç‚¹æ—¶é—´ `(start + end) / 2` åŒ¹é…è¯´è¯äººç‰‡æ®µ
- å¤„ç†æ—¶é—´å•ä½è½¬æ¢ (FunASR: ms, 3D-Speaker: s)
- è¯çº§æ—¶é—´æˆ³ç²¾ç¡®åˆ°æ¯ä¸ªå­—/è¯

### 3. æ€§èƒ½ä¼˜åŒ–

**å†…å­˜ä¼˜åŒ–**:
- ç¦ç”¨è¯­è¨€æ¨¡å‹èŠ‚çœ ~2GB å†…å­˜
- å‡å°‘çº¿ç¨‹æ•°é™ä½å¹¶å‘å ç”¨
- Docker å†…å­˜é™åˆ¶: 3GB (reservations: 2GB)

**è¯†åˆ«æ€§èƒ½**:
- å¤„ç†é€Ÿåº¦: ~2:1 (2åˆ†é’ŸéŸ³é¢‘éœ€è¦1åˆ†é’Ÿå¤„ç†)
- å¹¶å‘èƒ½åŠ›: å•çº¿ç¨‹æ¨¡å¼
- é€‚ç”¨åœºæ™¯: ç¦»çº¿è½¬å½•ã€ä¼šè®®çºªè¦ç”Ÿæˆ

---

## ğŸ“ ä½¿ç”¨è¯´æ˜

### å¯åŠ¨æœåŠ¡

```bash
# 1. å¯åŠ¨ FunASR
cd docker
docker compose -f docker-compose.funasr.yml up -d

# 2. å¯åŠ¨ 3D-Speaker æœåŠ¡
cd backend/python-services
uvicorn speaker_service.app:app --host 0.0.0.0 --port 5002

# 3. å¯åŠ¨åç«¯
cd backend
npm run dev

# 4. å¯åŠ¨å‰ç«¯
cd frontend
npm run dev
```

### API è°ƒç”¨ç¤ºä¾‹

```typescript
// 1. è½¬å½•éŸ³é¢‘æ–‡ä»¶
const result = await funasrWebSocketService.transcribeFile('/path/to/audio.wav')

// 2. å¤šè¯´è¯äººè½¬å½•
const transcription = await multiSpeakerTranscriptionService.transcribe(
  '/path/to/audio.wav',
  {
    language: 'zh-cn',
    enablePunctuation: true,
    enableWordTimestamp: true,
    userId: 'user-001'
  }
)

// 3. è®¿é—®ç»“æœ
console.log(`è¯†åˆ«åˆ° ${transcription.speakerCount} ä¸ªè¯´è¯äºº`)
console.log(`å…± ${transcription.segments.length} ä¸ªè½¬å½•ç‰‡æ®µ`)
```

---

## ğŸ¯ åç»­ä¼˜åŒ–å»ºè®®

### 1. çŸ­æœŸä¼˜åŒ– (1-2å‘¨)

- [ ] å®ç°éŸ³é¢‘ç‰‡æ®µåˆ†å‰²ï¼ˆæé«˜å£°çº¹è¯†åˆ«å‡†ç¡®åº¦ï¼‰
- [ ] æ·»åŠ ç¼“å­˜æœºåˆ¶ï¼ˆé¿å…é‡å¤è¯†åˆ«ï¼‰
- [ ] ä¼˜åŒ–æ—¶é—´æˆ³å¯¹é½ç®—æ³•
- [ ] æ·»åŠ è¿›åº¦å›è°ƒæ”¯æŒ

### 2. ä¸­æœŸä¼˜åŒ– (1ä¸ªæœˆ)

- [ ] æ”¯æŒå®æ—¶æµå¼è½¬å½•
- [ ] å¤šæ–‡ä»¶æ‰¹é‡å¤„ç†
- [ ] ç»“æœå¯¼å‡ºåŠŸèƒ½ï¼ˆJSON/VTT/SRTï¼‰
- [ ] æ€§èƒ½ç›‘æ§å’Œæ—¥å¿—åˆ†æ

### 3. é•¿æœŸä¼˜åŒ– (3ä¸ªæœˆ)

- [ ] GPU åŠ é€Ÿæ”¯æŒ
- [ ] åˆ†å¸ƒå¼éƒ¨ç½²
- [ ] æ¨¡å‹çƒ­æ›´æ–°
- [ ] è‡ªå®šä¹‰çƒ­è¯è®­ç»ƒ

---

## âš ï¸ å·²çŸ¥é™åˆ¶

1. **å•çº¿ç¨‹å¤„ç†**: å½“å‰é…ç½®ä¸ºå•çº¿ç¨‹ï¼Œä¸é€‚åˆé«˜å¹¶å‘åœºæ™¯
2. **ç¦»çº¿æ¨¡å¼**: ä»…æ”¯æŒæ–‡ä»¶è½¬å½•ï¼Œä¸æ”¯æŒå®æ—¶æµå¼
3. **å†…å­˜é™åˆ¶**: Docker é™åˆ¶ä¸º 3GBï¼Œå¤§æ–‡ä»¶å¯èƒ½å¤±è´¥
4. **è¯­è¨€æ¨¡å‹**: å·²ç¦ç”¨ä»¥èŠ‚çœå†…å­˜ï¼Œå¯èƒ½å½±å“è¯†åˆ«å‡†ç¡®åº¦

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

- [FunASR å®˜æ–¹æ–‡æ¡£](https://github.com/alibaba-damo-academy/FunASR)
- [3D-Speaker å®˜æ–¹æ–‡æ¡£](https://github.com/modelscope/3D-Speaker)
- [FunASR Docker ä¿®å¤æ€»ç»“](./FUNASR_FIX_SUMMARY.md)
- [FunASR 3D-Speaker é›†æˆæ–‡æ¡£](./FUNASR_3DSPEAKER_INTEGRATION.md)

---

## âœ… éªŒæ”¶æ£€æŸ¥æ¸…å•

- [x] FunASR Docker æœåŠ¡æ­£å¸¸è¿è¡Œ
- [x] 3D-Speaker æœåŠ¡æ­£å¸¸è¿è¡Œ
- [x] åç«¯ WebSocket è¿æ¥æˆåŠŸ
- [x] éŸ³é¢‘æ–‡ä»¶è¯†åˆ«æˆåŠŸ
- [x] è¿”å›è¯¦ç»†çš„æ—¶é—´æˆ³ä¿¡æ¯
- [x] å¤šè¯´è¯äººè½¬å½•æµç¨‹æ‰“é€š
- [x] å‰ç«¯ç»„ä»¶å¯ä»¥æ­£å¸¸æ˜¾ç¤ºç»“æœ
- [x] æµ‹è¯•è„šæœ¬éªŒè¯é€šè¿‡
- [x] æ–‡æ¡£å®Œæ•´æ›´æ–°

---

**é›†æˆçŠ¶æ€**: âœ… **å®Œå…¨å¯ç”¨**
**æ¨èåœºæ™¯**: ç¦»çº¿ä¼šè®®çºªè¦ç”Ÿæˆã€å¤šè¯´è¯äººè¯­éŸ³åˆ†æ
**ä¸‹ä¸€æ­¥**: å¯ä»¥å¼€å§‹å‰ç«¯ç•Œé¢ä¼˜åŒ–å’Œç”¨æˆ·ä½“éªŒæ”¹è¿›
